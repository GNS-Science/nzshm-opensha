# Removing 1e-20 buckets from `targetOnFaultSupraSeisMFDs`

## Problem
For `NZSHM22`, `targetOnFaultSupraSeisMFDs` stretched from magnitude 5.05 to 9.05. However, our min mag was `6.8` and we have no ruptures above `8.54`. This meant we zeroed out all bins below the 6.85 bin and above the 8.55 bin. Or rather, we set it to `1e-20`. In conjunction, we introduced special code in the `misfits` calculation that handles a corresponding misfit of `-1`

The goal of this investigation is 
- to be able to remove MFD bins that need to be zeroed out, and also 
- to be able to remove the special handling of -1 misfits.

## Approach
Kevin suggested:
- `filter` out ruptures before running the inversion. This basically means creating a new, smaller rupture set before running the inversion script.
- Suppress ruptures while `sampling` ruptures during the inversion. This means controlling which ruptures are chosen during the inversion algorithm run.

Code for this experiment is in `chore/303-global-minmag`

## Result

Both approaches work, but only the `sampling` approach seems to be able to replicate `NZSHM22` results. This is because `filtering` is applied before `target MFDs` are generated, and `sampling` is applied after target MFDs are generated.

With `sampling`, MFDs generated by `NZSHM22_CrustalInversionTargetMFDs` are identical to `NZSHM22` apart from the removal of buckets that were filled with 1e-20. With `filtering`, `targetOnFaultSupraSeisMFDs` is different. 

This is mostly because `totalSubSeismoOnFaultMFD` is based on the min mag of fault sections. If we remove ruptures below 6.8, the min mag of a number of sections changes.

## Data

These are 4-minute inversions using `totalSubSeismoOnFaultMFD` cropped to min mag 6.8 and max mag 8.6.

For the avoidance of doubt, the centre of the smallest bin is 6.85 with a delta of 0.1, resulting in a minimum magnitude of 6.8.

### NZSHM22 

For comparison the solution MFDs of a [representative NZSHM22 inversion](http://simple-toshi-ui.s3-website-ap-southeast-2.amazonaws.com/InversionSolution/SW52ZXJzaW9uU29sdXRpb246NjMzMzY3Mw==/DiagnosticReportTab) with original `targetOnFaultSupraSeisMFDs` containing 1e-20 values.

![screenshot](Screenshot%202024-03-25%20143539.png)

### Full Rupture Set

Ruptures of lower magnitude are unconstrained with `targetOnFaultSupraSeisMFDs` not having any bins below 6.8.

![Screenshot 2024-03-25 162802.png](Screenshot%202024-03-25%20162802.png)

### Sampling

Suppressing ruptures during the inversion results in a visually identical result to the NZSHM22 standard. Looking at the numbers, target MFDs are identical apart from cropping.

Sampling was implemented by setting `NZSHM22_CrustalInversionRunner.enableMinMaxSampler` to `true`, which will omit all ruptures that are out of range.

![Screenshot 2024-03-25 161605.png](Screenshot%202024-03-25%20161605.png)

### Filtering

When filtering ruptures before generating target MFDs, visual result are similar to NZSHM22 with a dip at 6.85. 

![Screenshot 2024-03-25 164358.png](Screenshot%202024-03-25%20164358.png)

The lower rate at 6.85 mag for the `targetOnFaultSupraSeisMFDs` can be explained by a larger `totalSubSeismoOnFaultMFD` compared to the original rupture set.

The filtered `totalSubSeismoOnFaultMFD` is larger by about 0.001 at around 6.85 as can be seen in this chart showing the difference between some MFDs for a filtered and an original rupture set.

![Screenshot 2024-03-27 101633.png](Screenshot%202024-03-27%20101633.png)

# Rates

## Sampled

After 10 minutes, sampled rates are similar to NZSHM22-equivalent rates in that mostly the same ruptures have rates in both cases. Rate values can vary. There are several ruptures that have a rate in the normal set but not in the sampled set. 

Here is an example comparison. Sampled rates on the left, unmodified rates on the right.

![Screenshot 2024-04-10 163311.png](Screenshot%202024-04-10%20163311.png)

In this example, rupture 179603 has a zero rate in the sampled dataset. The rupture has a 7.2 magnitude.

## Filtered

Filtered rates look much more different. While the sampled dataset assigns rates mostly to the same ruptures as the NZSHM22-equivalent dataset, filtered rates do not.

Here is a screenshot from the beginning of the files. Filtered on the left, unmodified rates on the right. Note that the original ruptures 6 and 10 would have been filtered out and the filtered data has been manually adjusted in this screenshot to align with the original ruptures.

![Screenshot 2024-04-10 165132.png](Screenshot%202024-04-10%20165132.png)
